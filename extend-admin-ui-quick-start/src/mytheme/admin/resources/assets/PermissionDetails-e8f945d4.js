import{u as G,d as M,a as _,r as x,n as U,j as e,C as z,f as H,b as $,e as W,k as V,A as k,aR as N,N as X,X as J,as as Q,w as Y,P as Z,g as ee,F as p,G as m,S as se,B as O,L as ie,at as te}from"./index-a3421f29.js";import{a as K}from"./policyRepresentation-3337b354.js";import{u as oe}from"./ConfirmDialog-09ff7a12.js";import{F as ae}from"./FormAccess-1cceaef6.js";import{K as re}from"./KeycloakTextArea-1b518857.js";import{K as B}from"./KeycloakTextInput-e7f6e917.js";import{V as ne}from"./ViewHeader-832ec56e.js";import{u as le}from"./useParams-5abeab7d.js";import{R as E}from"./ResourcesPolicySelect-e8d3e505.js";import{S as ce,a as q,b as de}from"./Select-0f56a9cc.js";import{R as pe}from"./Radio-e3ba1ffb.js";import{A as me}from"./Form-518a2cf2.js";import"./Modal-21c37af7.js";import"./copy-icon-a4fe01af.js";import"./GridItem-d34dae2e.js";import"./Text-564bf299.js";import"./ToolbarContent-7b435752.js";import"./check-fc57dbe1.js";import"./star-icon-6a7e7d25.js";const ue=({clientId:s,resourceId:u,preSelected:f})=>{const{t:j}=G("clients"),{adminClient:R}=M(),{control:d,getValues:D,setValue:C,formState:{errors:a}}=_(),[y,r]=x.useState([]),[o,S]=x.useState([]),[n,g]=x.useState(""),[F,b]=x.useState(!1),P=x.useRef(!0),A=D("scopes"),T=l=>l.map(c=>e.jsx(de,{value:c,children:c.name},c.id));return U(async()=>u?(u&&!P.current&&C("scopes",[]),P.current=!1,R.clients.listScopesByResource({id:s,resourceName:u})):R.clients.listAllScopes(Object.assign({id:s,deep:!1},n===""?null:{name:n})),l=>{r(l),n||S(l.filter(c=>A?.includes(c.id)))},[u,n]),e.jsx(z,{name:"scopes",defaultValue:f?[f]:[],control:d,rules:{validate:l=>l.length>0},render:({field:l})=>e.jsx(ce,{toggleId:"scopes",variant:q.typeaheadMulti,onToggle:b,onFilter:(c,h)=>(g(h),T(y)),onClear:()=>{l.onChange([]),g("")},selections:o.map(c=>c.name),onSelect:(c,h)=>{const I=typeof h=="string"?o.find(i=>i.name===h):h,t=o.find(i=>i.id===I.id)?o.filter(i=>i.id!==I.id):[...o,I];l.onChange(t.map(i=>i.id)),S(t),g("")},isOpen:F,"aria-labelledby":j("scopes"),validated:a.scopes?"error":"default",isDisabled:!!f,typeAheadAriaLabel:j("scopes"),children:T(y)})})};function qe(){const{t:s}=G("clients"),u=H({mode:"onChange"}),{register:f,control:j,reset:R,formState:{errors:d},handleSubmit:D}=u,C=$(),{id:a,realm:y,permissionType:r,permissionId:o,selectedId:S}=le(),{adminClient:n}=M(),{addAlert:g,addError:F}=W(),[b,P]=x.useState(),[A,T]=x.useState(!1);U(async()=>{if(!o)return{};const[t,i,L,w]=await Promise.all([n.clients.findOnePermission({id:a,type:r,permissionId:o}),n.clients.getAssociatedResources({id:a,permissionId:o}),n.clients.getAssociatedPolicies({id:a,permissionId:o}),n.clients.getAssociatedScopes({id:a,permissionId:o})]);if(!t)throw new Error(s("common:notFound"));return{permission:t,resources:i.map(v=>v._id),policies:L.map(v=>v.id),scopes:w.map(v=>v.id)}},({permission:t,resources:i,policies:L,scopes:w})=>{R({...t,resources:i,policies:L,scopes:w}),t&&"resourceType"in t&&T(!!t.resourceType),P({...t,resources:i,policies:L})},[]);const l=async t=>{try{if(o)await n.clients.updatePermission({id:a,type:r,permissionId:o},t);else{const i=await n.clients.createPermission({id:a,type:r},t);C(te({realm:y,id:a,permissionType:r,permissionId:i.id}))}g(s((o?"update":"create")+"PermissionSuccess"),k.success)}catch(i){F("clients:permissionSaveError",i)}},[c,h]=oe({titleKey:"clients:deletePermission",messageKey:s("deletePermissionConfirm",{permission:b?.name}),continueButtonVariant:V.danger,continueButtonLabel:"clients:confirm",onConfirm:async()=>{try{await n.clients.delPermission({id:a,type:r,permissionId:o}),g(s("permissionDeletedSuccess"),k.success),C(N({realm:y,clientId:a,tab:"permissions"}))}catch(t){F("clients:permissionDeletedError",t)}}}),I=X({control:j,name:"resources",defaultValue:[]});return b?e.jsxs(e.Fragment,{children:[e.jsx(h,{}),e.jsx(ne,{titleKey:o?b.name:`clients:create${Q(r)}BasedPermission`,dropdownItems:o?[e.jsx(Y,{"data-testid":"delete-resource",onClick:()=>c(),children:s("common:delete")},"delete")]:void 0}),e.jsx(Z,{variant:"light",children:e.jsx(ae,{isHorizontal:!0,role:"view-clients",onSubmit:D(l),children:e.jsxs(ee,{...u,children:[e.jsx(p,{label:s("common:name"),isRequired:!0,helperTextInvalid:s("common:required"),validated:d.name?"error":"default",fieldId:"name",labelIcon:e.jsx(m,{helpText:s("clients-help:permissionName"),fieldLabelId:"name"}),children:e.jsx(B,{id:"name",validated:d.name?"error":"default",...f("name",{required:!0})})}),e.jsx(p,{label:s("common:description"),fieldId:"description",labelIcon:e.jsx(m,{helpText:s("clients-help:permissionDescription"),fieldLabelId:"description"}),validated:d.description?"error":"default",helperTextInvalid:d.description?.message,children:e.jsx(re,{id:"description",validated:d.description?"error":"default",...f("description",{maxLength:{value:255,message:s("common:maxLength",{length:255})}})})}),e.jsx(p,{label:s("applyToResourceTypeFlag"),fieldId:"applyToResourceTypeFlag",labelIcon:e.jsx(m,{helpText:s("clients-help:applyToResourceTypeFlag"),fieldLabelId:"clients:applyToResourceTypeFlag"}),children:e.jsx(se,{id:"applyToResourceTypeFlag",name:"applyToResourceTypeFlag",label:s("common:on"),labelOff:s("common:off"),isChecked:A,onChange:T,"aria-label":s("applyToResourceTypeFlag")})}),A?e.jsx(p,{label:s("resourceType"),fieldId:"name",labelIcon:e.jsx(m,{helpText:s("clients-help:resourceType"),fieldLabelId:"resourceType"}),isRequired:r==="scope",children:e.jsx(B,{id:"resourceType",...f("resourceType",{required:r==="scope"})})}):e.jsx(p,{label:s("resources"),fieldId:"resources",labelIcon:e.jsx(m,{helpText:s("clients-help:permissionResources"),fieldLabelId:"clients:resources"}),helperTextInvalid:s("common:required"),validated:d.resources?"error":"default",isRequired:r!=="scope",children:e.jsx(E,{name:"resources",clientId:a,permissionId:o,preSelected:r==="scope"?void 0:S,variant:r==="scope"?q.typeahead:q.typeaheadMulti,isRequired:r!=="scope"})}),r==="scope"&&e.jsx(p,{label:s("authorizationScopes"),fieldId:"scopes",labelIcon:e.jsx(m,{helpText:s("clients-help:permissionScopes"),fieldLabelId:"clients:scopesSelect"}),helperTextInvalid:s("common:required"),validated:d.scopes?"error":"default",isRequired:!0,children:e.jsx(ue,{clientId:a,resourceId:I?.[0],preSelected:S})}),e.jsx(p,{label:s("policies"),fieldId:"policies",labelIcon:e.jsx(m,{helpText:s("clients-help:permissionPolicies"),fieldLabelId:"clients:policies"}),children:e.jsx(E,{name:"policies",clientId:a,permissionId:o})}),e.jsx(p,{label:s("decisionStrategy"),labelIcon:e.jsx(m,{helpText:s("clients-help:permissionDecisionStrategy"),fieldLabelId:"clients:decisionStrategy"}),fieldId:"policyEnforcementMode",hasNoPaddingTop:!0,children:e.jsx(z,{name:"decisionStrategy","data-testid":"decisionStrategy",defaultValue:K.UNANIMOUS,control:j,render:({field:t})=>e.jsx(e.Fragment,{children:Object.values(K).map(i=>e.jsx(pe,{id:i,"data-testid":i,isChecked:t.value===i,name:"decisionStrategies",onChange:()=>t.onChange(i),label:s(`decisionStrategies.${i}`),className:"pf-u-mb-md"},i))})})}),e.jsx(me,{children:e.jsxs("div",{className:"pf-u-mt-md",children:[e.jsx(O,{variant:V.primary,type:"submit","data-testid":"save",children:s("common:save")}),e.jsx(O,{variant:"link","data-testid":"cancel",component:t=>e.jsx(ie,{...t,to:N({realm:y,clientId:a,tab:"permissions"})}),children:s("common:cancel")})]})})]})})})]}):e.jsx(J,{})}export{qe as default};
//# sourceMappingURL=PermissionDetails-e8f945d4.js.map
