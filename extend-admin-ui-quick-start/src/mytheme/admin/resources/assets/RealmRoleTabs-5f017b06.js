import{b as Z,c as G,u as J,d as X,W as Re,j as e,P as q,J as fe,B as f,a8 as C,aZ as he,f as ye,a_ as xe,r as w,R as ge,e as je,N as U,n as ve,a9 as W,k as $,A,w as k,X as Ce,ab as _,a$ as H,aB as we,b0 as Ae,b1 as ke,b2 as Te,aP as De,b3 as Ie}from"./index-a3421f29.js";import{u as Q}from"./ConfirmDialog-09ff7a12.js";import{A as Ne}from"./AttributeForm-1b8e495d.js";import{P as Ee}from"./PermissionTab-c2ee2a77.js";import{R as Fe}from"./RoleForm-ecaa65a4.js";import{A as Se,R as Ke}from"./AddRoleMappingModal-abb19beb.js";import{R as Be,u as Pe}from"./RoutableTabs-7f56b0c5.js";import{V as Le}from"./ViewHeader-832ec56e.js";import{u as z}from"./useParams-5abeab7d.js";import{L as Me}from"./PaginatingTableToolbar-08ca9efb.js";import{K as Ve}from"./KeycloakDataTable-10a62d94.js";import{Q as Oe}from"./question-circle-icon-45a94074.js";import{a as h,b as y}from"./Tabs-5beaba80.js";import"./Modal-21c37af7.js";import"./FormAccess-1cceaef6.js";import"./copy-icon-a4fe01af.js";import"./Form-518a2cf2.js";import"./GridItem-d34dae2e.js";import"./KeyValueInput-ce08b760.js";import"./KeycloakTextInput-e7f6e917.js";import"./minus-icon-16876c86.js";import"./minus-circle-icon-6f9a971c.js";import"./ActionListItem-ab1a4322.js";import"./plus-circle-icon-cb854796.js";import"./EmptyStateBody-7b4fcee1.js";import"./useLocaleSort-3efc7c31.js";import"./Trans-2fec9e72.js";import"./Card-aa3ba03c.js";import"./CardTitle-9175b04a.js";import"./CardBody-519f6395.js";import"./Td-6d4ab209.js";import"./star-icon-6a7e7d25.js";import"./check-fc57dbe1.js";import"./grip-vertical-icon-cbeff50f.js";import"./Checkbox-d00621d8.js";import"./KeycloakTextArea-1b518857.js";import"./resource-08ae7dbc.js";import"./joinPath-55fd24bc.js";import"./filter-icon-9d72dc58.js";import"./ToolbarContent-7b435752.js";import"./Text-564bf299.js";import"./EmptyStateSecondaryActions-08edafb5.js";import"./TableToolbar-ee0c86ef.js";import"./plus-icon-2a767bad.js";import"./MenuList-e3786b59.js";const Ue=()=>{const o=Z(),{realm:n}=G(),{t:r}=J("roles"),{id:T,clientId:D}=z(),{adminClient:d}=X(),i=async(c,x)=>{const l=await d.roles.findOneById({id:T});if(!l)throw new Error(r("common:notFound"));return l.clientRole?d.clients.findUsersWithRole({roleName:l.name,id:D,first:c,max:x}):d.roles.findUsersWithRole({name:l.name,first:c,max:x})},{enabled:a}=Re();return e.jsx(q,{"data-testid":"users-page",variant:"light",children:e.jsx(Ve,{isPaginated:!0,loader:i,ariaLabelKey:"roles:roleList",searchPlaceholderKey:"",toolbarItem:a&&e.jsx(fe,{"aria-label":"Basic popover",position:"bottom",bodyContent:e.jsxs("div",{children:[r("roles:whoWillAppearPopoverText"),e.jsx(f,{className:"kc-groups-link",variant:"link",onClick:()=>o(`/${n}/groups`),children:r("common:groups")}),r("or"),e.jsxs(f,{className:"kc-users-link",variant:"link",onClick:()=>o(`/${n}/users`),children:[r("users"),"."]})]}),footerContent:r("roles:whoWillAppearPopoverFooterText"),children:e.jsx(f,{variant:"link",className:"kc-who-will-appear-button",icon:e.jsx(Oe,{}),children:r("roles:whoWillAppearLinkText")},"who-will-appear-button")}),emptyState:e.jsx(Me,{hasIcon:!0,message:r("noDirectUsers"),instructions:e.jsxs("div",{children:[r("noUsersEmptyStateDescription"),e.jsx(f,{className:"kc-groups-link-empty-state",variant:"link",onClick:()=>o(`/${n}/groups`),children:r("common:groups")}),r("or"),e.jsx(f,{className:"kc-users-link-empty-state",variant:"link",onClick:()=>o(`/${n}/users`),children:r("users")}),r("noUsersEmptyStateDescriptionContinued")]})}),columns:[{name:"username",displayKey:"roles:userName",cellFormatters:[C()]},{name:"email",displayKey:"roles:email",cellFormatters:[C()]},{name:"lastName",displayKey:"roles:lastName",cellFormatters:[C()]},{name:"firstName",displayKey:"roles:firstName",cellFormatters:[he(),C()]}]})})};function St(){const{t:o}=J("roles"),n=ye({mode:"onChange"}),{control:r,reset:T,setValue:D}=n,d=Z(),{adminClient:i}=X(),{id:a,clientId:c}=z(),{pathname:x}=xe(),{realm:l}=G(),[N,Y]=w.useState(0),[ee,E]=w.useState(),{profileInfo:te}=ge(),F=()=>Y(N+1),{addAlert:g,addError:j}=je(),[S,K]=w.useState(!1),oe=t=>{const{attributes:s,...p}=t;return{attributes:Ie(s),...p}},m=U({control:r,defaultValue:void 0,name:"name"}),B=U({control:r,defaultValue:!1,name:"composite"}),[I,se]=w.useState();ve(async()=>{const[t,s]=await Promise.all([i.realms.findOne({realm:l}),i.roles.findOneById({id:a})]);return{realm:t,role:s}},({realm:t,role:s})=>{if(!t||!s)throw new Error(o("common:notFound"));const p=oe(s);T(p),E(p.attributes),se(t)},[N]);const P=async t=>{try{const{attributes:s,...p}=t,R=p;R.name=R.name?.trim(),R.attributes=we(s),c?await i.clients.updateRole({id:c,roleName:t.name},R):await i.roles.updateById({id:a},R),E(s),g(o("roleSaveSuccess"),A.success)}catch(s){j("roles:roleSaveError",s)}},L=W(Ae.path),u=W(ke.path),re=()=>{if(L)return H({realm:l});if(u)return _({realm:l,clientId:u.params.clientId,tab:"roles"});throw new Error("Roles overview route could not be determined.")},v=t=>{if(L)return Te({realm:l,id:a,tab:t});if(u)return De({realm:l,id:a,clientId:u.params.clientId,tab:t});throw new Error("Route could not be determined.")},b=t=>Pe(v(t)),ae=b("details"),le=b("associated-roles"),ie=b("attributes"),ne=b("users-in-role"),ce=b("permissions"),[M,me]=Q({titleKey:"roles:roleDeleteConfirm",messageKey:o("roles:roleDeleteConfirmDialog",{selectedRoleName:m||o("createRole")}),continueButtonLabel:"common:delete",continueButtonVariant:$.danger,onConfirm:async()=>{try{c?await i.clients.delRole({id:c,roleName:m}):await i.roles.delById({id:a}),g(o("roleDeletedSuccess"),A.success),d(re())}catch(t){j("roles:roleDeleteError",t)}}}),de=x.includes("associated-roles")?[e.jsx(k,{component:"button",onClick:()=>ue(),children:o("roles:removeAllAssociatedRoles")},"delete-all-associated"),e.jsx(k,{component:"button",onClick:()=>{M()},children:o("deleteRole")},"delete-role")]:[e.jsx(k,{"data-testid":"add-roles",component:"button",onClick:()=>be(),children:o("addAssociatedRolesText")},"toggle-modal"),e.jsx(k,{component:"button",onClick:()=>M(),children:o("deleteRole")},"delete-role")],[ue,pe]=Q({titleKey:o("roles:removeAllAssociatedRoles")+"?",messageKey:o("roles:removeAllAssociatedRolesConfirmDialog",{name:m||o("createRole")}),continueButtonLabel:"common:delete",continueButtonVariant:$.danger,onConfirm:async()=>{try{const t=await i.roles.getCompositeRoles({id:a});await i.roles.delCompositeRoles({id:a},t),g(o("compositeRoleOff"),A.success,o("compositesRemovedAlertDescription")),d(v("details")),F()}catch(t){j("roles:roleDeleteError",t)}}}),be=()=>{K(!S)},V=async t=>{try{await i.roles.createComposite({roleId:a,realm:I.realm},t),F(),d(v("associated-roles")),g(o("addAssociatedRolesSuccess"),A.success)}catch(s){j("roles:addAssociatedRolesError",s)}},O=t=>I?.defaultRole.name===t;return I?e.jsxs(e.Fragment,{children:[e.jsx(me,{}),e.jsx(pe,{}),S&&e.jsx(Se,{id:a,type:"roles",name:m,onAssign:t=>V(t.map(s=>s.role)),onClose:()=>K(!1)}),e.jsx(Le,{titleKey:m,badges:[{id:"composite-role-badge",text:B?o("composite"):"",readonly:!0}],actionsDropdownId:"roles-actions-dropdown",dropdownItems:de,divider:!1}),e.jsx(q,{variant:"light",className:"pf-u-p-0",children:e.jsxs(Be,{isBox:!0,mountOnEnter:!0,defaultLocation:v("details"),children:[e.jsx(h,{title:e.jsx(y,{children:o("common:details")}),...ae,children:e.jsx(Fe,{form:n,onSubmit:P,role:u?"manage-clients":"manage-realm",cancelLink:u?_({realm:l,clientId:c,tab:"roles"}):H({realm:l}),editMode:!0})}),B&&e.jsx(h,{"data-testid":"associatedRolesTab",title:e.jsx(y,{children:o("associatedRolesText")}),...le,children:e.jsx(Ke,{name:m,id:a,type:"roles",isManager:!0,save:t=>V(t.map(s=>s.role))})}),!O(m)&&e.jsx(h,{"data-testid":"attributesTab",className:"kc-attributes-tab",title:e.jsx(y,{children:o("common:attributes")}),...ie,children:e.jsx(Ne,{form:n,save:P,reset:()=>D("attributes",ee,{shouldDirty:!1})})}),!O(m)&&e.jsx(h,{title:e.jsx(y,{children:o("usersInRole")}),...ne,children:e.jsx(Ue,{"data-cy":"users-in-role-tab"})}),!te?.disabledFeatures?.includes("ADMIN_FINE_GRAINED_AUTHZ")&&e.jsx(h,{title:e.jsx(y,{children:o("common:permissions")}),...ce,children:e.jsx(Ee,{id:a,type:"roles"})})]})})]}):e.jsx(Ce,{})}export{St as default};
//# sourceMappingURL=RealmRoleTabs-5f017b06.js.map
