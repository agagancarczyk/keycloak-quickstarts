import{u as f,j as e,F as b,d as J,a as P,r as j,N as F,n as G,X as se,G as T,C as N,U as M,S as re,R as Q,f as X,B as w,g as Y,k as le,b as ne,e as ie,P as oe,L as de,d9 as Z,A as ce,q as ue,dj as me}from"./index-a3421f29.js";import{S as pe}from"./ScrollForm-a21fd695.js";import{V as he}from"./ViewHeader-832ec56e.js";import{u as W}from"./useParams-5abeab7d.js";import{F as K}from"./FormAccess-1cceaef6.js";import{K as be}from"./KeyValueInput-ce08b760.js";import"./realm-settings-section-4ed993c7.js";import{G as ee,a as H}from"./GridItem-d34dae2e.js";import{K as _}from"./KeycloakTextInput-e7f6e917.js";import{C as U}from"./Checkbox-d00621d8.js";import{u as ge}from"./ConfirmDialog-09ff7a12.js";import{u as te}from"./useToggle-a9cb2c55.js";import{D as xe}from"./DynamicComponents-72877b30.js";import{S as R,a as D,b as I}from"./Select-0f56a9cc.js";import{M as je,a as ve}from"./Modal-21c37af7.js";import{F as ae,A as fe}from"./Form-518a2cf2.js";import{P as qe}from"./plus-circle-icon-cb854796.js";import{R as Ve,S as ye,O as B,U as L,T as Se,P as E}from"./Td-6d4ab209.js";import{T as ke,a as Ce}from"./Text-564bf299.js";import{U as Ne}from"./UserProfileContext-1adc9dc8.js";import{i as Te}from"./isEqual-69fbe00f.js";import{R as A}from"./Radio-e3ba1ffb.js";import"./FormPanel-11cb7e22.js";import"./CardHeader-457352d1.js";import"./Card-aa3ba03c.js";import"./CardTitle-9175b04a.js";import"./CardBody-519f6395.js";import"./ToolbarContent-7b435752.js";import"./copy-icon-a4fe01af.js";import"./minus-icon-16876c86.js";import"./minus-circle-icon-6f9a971c.js";import"./ActionListItem-ab1a4322.js";import"./EmptyStateBody-7b4fcee1.js";import"./check-fc57dbe1.js";import"./ClientSelect-3f0fc581.js";import"./FileUpload-ca37c1a6.js";import"./CodeEditor-2fb93648.js";import"./EmptyStateSecondaryActions-08edafb5.js";import"./GroupPickerDialog-caf8c38d.js";import"./PaginatingTableToolbar-08ca9efb.js";import"./TableToolbar-ee0c86ef.js";import"./DataListItemRow-75e02946.js";import"./data-list-7d55714c.js";import"./grip-vertical-icon-cbeff50f.js";import"./FlexItem-65b5f999.js";import"./MultiLineInput-14187d1c.js";import"./PasswordInput-85f9399f.js";import"./AddRoleMappingModal-abb19beb.js";import"./KeycloakDataTable-10a62d94.js";import"./useLocaleSort-3efc7c31.js";import"./resource-08ae7dbc.js";import"./joinPath-55fd24bc.js";import"./filter-icon-9d72dc58.js";import"./KeycloakTextArea-1b518857.js";import"./star-icon-6a7e7d25.js";const Ae=()=>{const{t}=f("realm-settings");return e.jsx(K,{role:"manage-realm",isHorizontal:!0,children:e.jsx(b,{hasNoPaddingTop:!0,label:t("annotations"),fieldId:"kc-annotations",className:"kc-annotations-label",children:e.jsx(ee,{className:"kc-annotations",children:e.jsx(H,{children:e.jsx(be,{name:"annotations"})})})})})},$=[{label:"requiredForLabel.both",value:["admin","user"]},{label:"requiredForLabel.users",value:["user"]},{label:"requiredForLabel.admins",value:["admin"]}],Ie=()=>{const{t}=f("realm-settings"),{adminClient:n}=J(),l=P(),[r,o]=j.useState(),[c,p]=j.useState(),[g,m]=j.useState(!1),[u,h]=j.useState(!1),[d,i]=j.useState(!1),{attributeName:V}=W(),y=!!V,S=F({control:l.control,name:"selector.scopes",defaultValue:[]}),k=F({control:l.control,name:"required.scopes",defaultValue:[]}),C=F({control:l.control,name:"isRequired",defaultValue:!1});return G(()=>n.clientScopes.find(),o,[]),G(()=>n.users.getProfile(),p,[]),r?e.jsxs(K,{role:"manage-realm",isHorizontal:!0,children:[e.jsx(b,{label:t("attributeName"),labelIcon:e.jsx(T,{helpText:t("realm-settings-help:attributeNameHelp"),fieldLabelId:"realm-settings:attributeName"}),fieldId:"kc-attribute-name",isRequired:!0,validated:l.formState.errors.name?"error":"default",helperTextInvalid:t("validateName"),children:e.jsx(_,{isRequired:!0,id:"kc-attribute-name",defaultValue:"","data-testid":"attribute-name",isDisabled:y,validated:l.formState.errors.name?"error":"default",...l.register("name",{required:!0})})}),e.jsx(b,{label:t("attributeDisplayName"),labelIcon:e.jsx(T,{helpText:t("realm-settings-help:attributeDisplayNameHelp"),fieldLabelId:"realm-settings:attributeDisplayName"}),fieldId:"kc-attribute-display-name",children:e.jsx(_,{id:"kc-attribute-display-name",defaultValue:"","data-testid":"attribute-display-name",...l.register("displayName")})}),e.jsx(b,{label:t("attributeGroup"),labelIcon:e.jsx(T,{helpText:t("realm-setting-help:attributeGroupHelp"),fieldLabelId:"realm-setting:attributeGroup"}),fieldId:"kc-attribute-group",children:e.jsx(N,{name:"group",defaultValue:"",control:l.control,render:({field:s})=>e.jsx(R,{toggleId:"kc-attributeGroup",onToggle:()=>i(!d),isOpen:d,onSelect:(a,x)=>{s.onChange(x.toString()),i(!1)},selections:[s.value||t("common:none")],variant:D.single,children:[e.jsx(I,{value:"",children:t("common:none")},"empty"),...c?.groups?.map(a=>e.jsx(I,{value:a.name,children:a.name},a.name))||[]]})})}),!Oe.includes(V)&&e.jsxs(e.Fragment,{children:[e.jsx(M,{}),e.jsxs(b,{label:t("enabledWhen"),fieldId:"enabledWhen",hasNoPaddingTop:!0,children:[e.jsx(A,{id:"always","data-testid":"always",isChecked:S.length===r.length,name:"enabledWhen",label:t("always"),onChange:s=>{s?l.setValue("selector.scopes",r.map(a=>a.name)):l.setValue("selector.scopes",[])},className:"pf-u-mb-md"}),e.jsx(A,{id:"scopesAsRequested","data-testid":"scopesAsRequested",isChecked:S.length!==r.length,name:"enabledWhen",label:t("scopesAsRequested"),onChange:s=>{s?l.setValue("selector.scopes",[]):l.setValue("selector.scopes",r.map(a=>a.name))},className:"pf-u-mb-md"})]}),e.jsx(b,{fieldId:"kc-scope-enabled-when",children:e.jsx(N,{name:"selector.scopes",control:l.control,defaultValue:r.map(s=>s.name),render:({field:s})=>e.jsx(R,{name:"scopes","data-testid":"enabled-when-scope-field",variant:D.typeaheadMulti,typeAheadAriaLabel:"Select",chipGroupProps:{numChips:3,expandedText:t("common:hide"),collapsedText:t("common:showRemaining")},onToggle:a=>m(a),selections:s.value,onSelect:(a,x)=>{const v=x.toString();let q=[""];s.value?q=s.value.includes(v)?s.value.filter(O=>O!==v):[...s.value,v]:q=[v],s.onChange(q)},onClear:a=>{a.stopPropagation(),s.onChange([])},isOpen:g,isDisabled:S.length===r.length,"aria-labelledby":"scope",children:r.map(a=>e.jsx(I,{value:a.name},a.name))})})}),e.jsx(M,{}),e.jsx(b,{label:t("required"),labelIcon:e.jsx(T,{helpText:t("realm-settings-help:requiredHelp"),fieldLabelId:"realm-settings:required"}),fieldId:"kc-required",hasNoPaddingTop:!0,children:e.jsx(N,{name:"isRequired","data-testid":"required",defaultValue:!1,control:l.control,render:({field:s})=>e.jsx(re,{id:"kc-required",onChange:s.onChange,isChecked:s.value,label:t("common:on"),labelOff:t("common:off"),"aria-label":t("required")})})}),C&&e.jsxs(e.Fragment,{children:[e.jsx(b,{label:t("requiredFor"),fieldId:"requiredFor",hasNoPaddingTop:!0,children:e.jsx(N,{name:"required.roles","data-testid":"requiredFor",defaultValue:$[0].value,control:l.control,render:({field:s})=>e.jsx("div",{className:"kc-requiredFor",children:$.map(a=>e.jsx(A,{id:a.label,"data-testid":a.label,isChecked:Te(s.value,a.value),name:"roles",onChange:()=>{s.onChange(a.value)},label:t(a.label),className:"kc-requiredFor-option"},a.label))})})}),e.jsxs(b,{label:t("requiredWhen"),fieldId:"requiredWhen",hasNoPaddingTop:!0,children:[e.jsx(A,{id:"requiredAlways","data-testid":"requiredAlways",isChecked:k.length===r.length,name:"requiredWhen",label:t("always"),onChange:s=>{s?l.setValue("required.scopes",r.map(a=>a.name)):l.setValue("required.scopes",[])},className:"pf-u-mb-md"}),e.jsx(A,{id:"requiredScopesAsRequested","data-testid":"requiredScopesAsRequested",isChecked:k.length!==r.length,name:"requiredWhen",label:t("scopesAsRequested"),onChange:s=>{s?l.setValue("required.scopes",[]):l.setValue("required.scopes",r.map(a=>a.name))},className:"pf-u-mb-md"})]}),e.jsx(b,{fieldId:"kc-scope-required-when",children:e.jsx(N,{name:"required.scopes",control:l.control,defaultValue:[],render:({field:s})=>e.jsx(R,{name:"scopeRequired","data-testid":"required-when-scope-field",variant:D.typeaheadMulti,typeAheadAriaLabel:"Select",chipGroupProps:{numChips:3,expandedText:t("common:hide"),collapsedText:t("common:showRemaining")},onToggle:a=>h(a),selections:s.value,onSelect:(a,x)=>{const v=x.toString();let q=[""];s.value?q=s.value.includes(v)?s.value.filter(O=>O!==v):[...s.value,v]:q=[v],s.onChange(q)},onClear:a=>{a.stopPropagation(),s.onChange([])},isOpen:u,isDisabled:k.length===r.length,"aria-labelledby":"scope",children:r.map(a=>e.jsx(I,{value:a.name},a.name))})})})]})]})]}):e.jsx(se,{})},z=({name:t})=>{const{t:n}=f("realm-settings"),{control:l}=P();return e.jsx(ee,{children:e.jsx(N,{name:`permissions.${t}`,control:l,defaultValue:[],render:({field:r})=>e.jsxs(e.Fragment,{children:[e.jsx(H,{lg:4,sm:6,children:e.jsx(U,{id:`user-${t}`,label:n("user"),value:"user","data-testid":`user-${t}`,isChecked:r.value.includes("user"),onChange:()=>{const o="user",c=r.value.includes(o)?r.value.filter(p=>p!==o):[...r.value,o];r.onChange(c)}})}),e.jsx(H,{lg:8,sm:6,children:e.jsx(U,{id:`admin-${t}`,label:n("admin"),value:"admin","data-testid":`admin-${t}`,isChecked:r.value.includes("admin"),onChange:()=>{const o="admin",c=r.value.includes(o)?r.value.filter(p=>p!==o):[...r.value,o];r.onChange(c)}})})]})})})},we=()=>{const{t}=f("realm-settings");return e.jsxs(K,{role:"manage-realm",isHorizontal:!0,children:[e.jsx(b,{hasNoPaddingTop:!0,label:t("whoCanEdit"),labelIcon:e.jsx(T,{helpText:t("realm-settings-help:whoCanEditHelp"),fieldLabelId:"realm-settings:whoCanEdit"}),fieldId:"kc-who-can-edit",children:e.jsx(z,{name:"edit"})}),e.jsx(b,{hasNoPaddingTop:!0,label:t("whoCanView"),labelIcon:e.jsx(T,{helpText:t("realm-settings-help:whoCanViewHelp"),fieldLabelId:"realm-settings:whoCanView"}),fieldId:"kc-who-can-view",children:e.jsx(z,{name:"view"})})]})},Fe=({selectedValidators:t,onChange:n})=>{const{t:l}=f("realm-settings"),r=Q().componentTypes?.["org.keycloak.validate.Validator"]||[],o=j.useMemo(()=>r.filter(({id:u})=>!t.includes(u)),[t]),[c,p]=te(),[g,m]=j.useState();return e.jsx(b,{label:l("validatorType"),fieldId:"validator",children:e.jsx(R,{toggleId:"validator",onToggle:p,onSelect:(u,h)=>{const d=h;n(d),m(d),p()},selections:g?.id,variant:"single","aria-label":l("selectOne"),isOpen:c,placeholderText:l("common:choose"),menuAppendTo:"parent",maxHeight:300,children:o.map(u=>e.jsx(I,{selected:g?.id===u.id,value:u,description:u.helpText,children:u.id},u.id))})})},Re=({selectedValidators:t,toggleDialog:n,onConfirm:l})=>{const{t:r}=f("realm-settings"),[o,c]=j.useState(),p=Q().componentTypes?.["org.keycloak.validate.Validator"].length===t.length,g=X(),{handleSubmit:m}=g,u=h=>{l({...h,id:o?.id}),n()};return e.jsx(je,{variant:ve.small,title:r("addValidator"),isOpen:!0,onClose:n,actions:[e.jsx(w,{"data-testid":"save-validator-role-button",variant:"primary",type:"submit",form:"add-validator",children:r("common:save")},"save"),e.jsx(w,{"data-testid":"cancel-validator-role-button",variant:"link",onClick:n,children:r("common:cancel")},"cancel")],children:p?r("emptyValidators"):e.jsxs(ae,{id:"add-validator",onSubmit:m(u),children:[e.jsx(Fe,{selectedValidators:t.map(h=>h.key),onChange:c}),o&&e.jsx(Y,{...g,children:e.jsx(xe,{properties:o.properties})})]})})},Pe=()=>{const{t}=f("realm-settings"),[n,l]=te(),[r,o]=j.useState(),{setValue:c,control:p,register:g}=P(),m=F({name:"validations",control:p,defaultValue:[]});j.useEffect(()=>{g("validations")},[]);const[u,h]=ge({titleKey:t("deleteValidatorConfirmTitle"),messageKey:t("deleteValidatorConfirmMsg",{validatorName:r}),continueButtonLabel:"common:delete",continueButtonVariant:le.danger,onConfirm:async()=>{const d=m.filter(i=>i.key!==r);c("validations",[...d])}});return e.jsxs(e.Fragment,{children:[n&&e.jsx(Re,{selectedValidators:m,onConfirm:d=>{c("validations",[...m,{key:d.id,value:d.config}])},toggleDialog:l}),e.jsx(h,{}),e.jsxs("div",{className:"kc-attributes-validations",children:[e.jsx(w,{id:"addValidator",onClick:()=>l(),variant:"link","data-testid":"addValidator",className:"kc--attributes-validations--add-validation-button",icon:e.jsx(qe,{}),children:t("realm-settings:addValidator")}),e.jsx(M,{}),m.length!==0?e.jsxs(Ve,{children:[e.jsx(ye,{children:e.jsxs(B,{children:[e.jsx(L,{children:t("validatorColNames.colName")}),e.jsx(L,{children:t("validatorColNames.colConfig")}),e.jsx(L,{})]})}),e.jsx(Se,{children:m.map(d=>e.jsxs(B,{children:[e.jsx(E,{dataLabel:t("validatorColNames.colName"),children:d.key}),e.jsx(E,{dataLabel:t("validatorColNames.colConfig"),children:JSON.stringify(d.value)}),e.jsx(E,{className:"kc--attributes-validations--action-cell",children:e.jsx(w,{variant:"link","data-testid":"deleteValidator",onClick:()=>{u(),o(d.key)},children:t("common:delete")},"validator")})]},d.key))})]}):e.jsx(ke,{className:"kc-emptyValidators",component:Ce.h6,children:t("realm-settings:emptyValidators")})]})]})},Oe=["username","email"],De=({save:t})=>{const{t:n}=f("realm-settings"),l=P(),{realm:r,attributeName:o}=W(),c=!!o;return e.jsxs(Ne,{children:[e.jsx(pe,{sections:[{title:n("generalSettings"),panel:e.jsx(Ie,{})},{title:n("permission"),panel:e.jsx(we,{})},{title:n("validations"),panel:e.jsx(Pe,{})},{title:n("annotations"),panel:e.jsx(Ae,{})}]}),e.jsx(ae,{onSubmit:l.handleSubmit(t),children:e.jsxs(fe,{className:"keycloak__form_actions",children:[e.jsx(w,{variant:"primary",type:"submit","data-testid":"attribute-create",children:n(c?"common:save":"common:create")}),e.jsx(de,{to:Z({realm:r,tab:"attributes"}),"data-testid":"attribute-cancel",className:"kc-attributeCancel",children:n("common:cancel")})]})})]})};function Et(){const{realm:t,attributeName:n}=W(),{adminClient:l}=J(),r=X(),{t:o}=f("realm-settings"),c=ne(),{addAlert:p,addError:g}=ie(),[m,u]=j.useState(null),h=!!n;G(()=>l.users.getProfile(),i=>{u(i);const{annotations:V,validations:y,permissions:S,selector:k,required:C,...s}=i.attributes.find(a=>a.name===n)||{};ue(s,r.setValue),Object.entries(me.flatten({permissions:S,selector:k,required:C},{safe:!0})).map(([a,x])=>r.setValue(a,x)),r.setValue("annotations",Object.entries(V||{}).map(([a,x])=>({key:a,value:x}))),r.setValue("validations",Object.entries(y||{}).map(([a,x])=>({key:a,value:x}))),r.setValue("isRequired",C!==void 0)},[]);const d=async i=>{const V=i.validations.reduce((s,a)=>(s[a.key]=a.value?.length===0?{}:a.value,s),{}),y=i.annotations.reduce((s,a)=>Object.assign(s,{[a.key]:a.value}),{}),C=h?(()=>m?.attributes.map(s=>s.name!==n?s:(delete s.required,Object.assign({...s,name:n,displayName:i.displayName,selector:i.selector,permissions:i.permissions,annotations:y,validations:V},i.isRequired?{required:i.required}:void 0,i.group?{group:i.group}:{group:null}))))():(()=>m?.attributes.concat([Object.assign({name:i.name,displayName:i.displayName,required:i.isRequired?i.required:{},selector:i.selector,permissions:i.permissions,annotations:y},i.isRequired?{required:i.required}:void 0,i.group?{group:i.group}:void 0)]))();try{await l.users.updateProfile({...m,attributes:C,realm:t}),c(Z({realm:t,tab:"attributes"})),p(o("realm-settings:createAttributeSuccess"),ce.success)}catch(s){g("realm-settings:createAttributeError",s)}};return e.jsxs(Y,{...r,children:[e.jsx(he,{titleKey:h?n:o("createAttribute"),subKey:h?"":o("createAttributeSubTitle")}),e.jsx(oe,{variant:"light",children:e.jsx(De,{save:()=>r.handleSubmit(d)()})})]})}export{Oe as USERNAME_EMAIL,Et as default};
//# sourceMappingURL=NewAttributeSettings-8f32001c.js.map
