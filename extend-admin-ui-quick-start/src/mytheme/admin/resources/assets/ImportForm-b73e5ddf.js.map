{"version":3,"file":"ImportForm-b73e5ddf.js","sources":["../../src/clients/import/ImportForm.tsx"],"sourcesContent":["import { Language } from \"@patternfly/react-code-editor\";\nimport {\n  ActionGroup,\n  AlertVariant,\n  Button,\n  FormGroup,\n  PageSection,\n} from \"@patternfly/react-core\";\nimport { useState } from \"react\";\nimport { FormProvider, useForm } from \"react-hook-form\";\nimport { useTranslation } from \"react-i18next\";\nimport { Link, useNavigate } from \"react-router-dom\";\n\nimport type ClientRepresentation from \"@keycloak/keycloak-admin-client/lib/defs/clientRepresentation\";\n\nimport { useAlerts } from \"../../components/alert/Alerts\";\nimport { FormAccess } from \"../../components/form-access/FormAccess\";\nimport { FileUploadForm } from \"../../components/json-file-upload/FileUploadForm\";\nimport { KeycloakTextInput } from \"../../components/keycloak-text-input/KeycloakTextInput\";\nimport { ViewHeader } from \"../../components/view-header/ViewHeader\";\nimport { useAdminClient } from \"../../context/auth/AdminClient\";\nimport { useRealm } from \"../../context/realm-context/RealmContext\";\nimport {\n  addTrailingSlash,\n  convertFormValuesToObject,\n  convertToFormValues,\n} from \"../../util\";\nimport { getAuthorizationHeaders } from \"../../utils/getAuthorizationHeaders\";\nimport { CapabilityConfig } from \"../add/CapabilityConfig\";\nimport { ClientDescription } from \"../ClientDescription\";\nimport { FormFields } from \"../ClientDetails\";\nimport { toClient } from \"../routes/Client\";\nimport { toClients } from \"../routes/Clients\";\n\nconst isXml = (text: string) => text.match(/(<.[^(><.)]+>)/g);\n\nexport default function ImportForm() {\n  const { t } = useTranslation(\"clients\");\n  const navigate = useNavigate();\n  const { adminClient } = useAdminClient();\n  const { realm } = useRealm();\n  const form = useForm<FormFields>();\n  const { register, handleSubmit, setValue } = form;\n  const [imported, setImported] = useState<ClientRepresentation>({});\n\n  const { addAlert, addError } = useAlerts();\n\n  const handleFileChange = async (contents: string) => {\n    try {\n      const parsed = await parseFileContents(contents);\n\n      convertToFormValues(parsed, setValue);\n      setImported(parsed);\n    } catch (error) {\n      addError(\"clients:importParseError\", error);\n    }\n  };\n\n  async function parseFileContents(\n    contents: string\n  ): Promise<ClientRepresentation> {\n    if (!isXml(contents)) {\n      return JSON.parse(contents);\n    }\n\n    const response = await fetch(\n      `${addTrailingSlash(\n        adminClient.baseUrl\n      )}admin/realms/${realm}/client-description-converter`,\n      {\n        method: \"POST\",\n        body: contents,\n        headers: getAuthorizationHeaders(await adminClient.getAccessToken()),\n      }\n    );\n\n    if (!response.ok) {\n      throw new Error(\n        `Server responded with invalid status: ${response.statusText}`\n      );\n    }\n\n    return response.json();\n  }\n\n  const save = async (client: ClientRepresentation) => {\n    try {\n      const newClient = await adminClient.clients.create({\n        ...imported,\n        ...convertFormValuesToObject({\n          ...client,\n          attributes: client.attributes || {},\n        }),\n      });\n      addAlert(t(\"clientImportSuccess\"), AlertVariant.success);\n      navigate(toClient({ realm, clientId: newClient.id, tab: \"settings\" }));\n    } catch (error) {\n      addError(\"clients:clientImportError\", error);\n    }\n  };\n\n  return (\n    <>\n      <ViewHeader\n        titleKey=\"clients:importClient\"\n        subKey=\"clients:clientsExplain\"\n      />\n      <PageSection variant=\"light\">\n        <FormAccess\n          isHorizontal\n          onSubmit={handleSubmit(save)}\n          role=\"manage-clients\"\n        >\n          <FormProvider {...form}>\n            <FileUploadForm\n              id=\"realm-file\"\n              language={Language.json}\n              extension=\".json,.xml\"\n              helpText={t(\"common-help:helpFileUploadClient\")}\n              onChange={handleFileChange}\n            />\n            <ClientDescription hasConfigureAccess />\n            <FormGroup label={t(\"common:type\")} fieldId=\"kc-type\">\n              <KeycloakTextInput\n                id=\"kc-type\"\n                isReadOnly\n                {...register(\"protocol\")}\n              />\n            </FormGroup>\n            <CapabilityConfig unWrap={true} />\n            <ActionGroup>\n              <Button variant=\"primary\" type=\"submit\">\n                {t(\"common:save\")}\n              </Button>\n              <Button\n                variant=\"link\"\n                component={(props) => (\n                  <Link {...props} to={toClients({ realm })} />\n                )}\n              >\n                {t(\"common:cancel\")}\n              </Button>\n            </ActionGroup>\n          </FormProvider>\n        </FormAccess>\n      </PageSection>\n    </>\n  );\n}\n"],"names":["isXml","text","ImportForm","t","useTranslation","navigate","useNavigate","adminClient","useAdminClient","realm","useRealm","form","useForm","register","handleSubmit","setValue","imported","setImported","useState","addAlert","addError","useAlerts","handleFileChange","contents","parsed","parseFileContents","convertToFormValues","error","response","addTrailingSlash","getAuthorizationHeaders","save","client","newClient","convertFormValuesToObject","AlertVariant","toClient","jsxs","Fragment","jsx","ViewHeader","PageSection","FormAccess","FormProvider","FileUploadForm","Language","ClientDescription","FormGroup","KeycloakTextInput","CapabilityConfig","ActionGroup","Button","props","Link","toClients"],"mappings":"40BAkCA,MAAMA,EAASC,GAAiBA,EAAK,MAAM,iBAAiB,EAE5D,SAAwBC,IAAa,CACnC,KAAM,CAAE,EAAAC,CAAA,EAAMC,EAAe,SAAS,EAChCC,EAAWC,IACX,CAAE,YAAAC,GAAgBC,IAClB,CAAE,MAAAC,GAAUC,IACZC,EAAOC,IACP,CAAE,SAAAC,EAAU,aAAAC,EAAc,SAAAC,CAAA,EAAaJ,EACvC,CAACK,EAAUC,CAAW,EAAIC,EAAA,SAA+B,CAAE,CAAA,EAE3D,CAAE,SAAAC,EAAU,SAAAC,CAAS,EAAIC,EAAU,EAEnCC,EAAmB,MAAOC,GAAqB,CAC/C,GAAA,CACI,MAAAC,EAAS,MAAMC,EAAkBF,CAAQ,EAE/CG,EAAoBF,EAAQT,CAAQ,EACpCE,EAAYO,CAAM,QACXG,GACPP,EAAS,2BAA4BO,CAAK,CAC5C,CAAA,EAGF,eAAeF,EACbF,EAC+B,CAC3B,GAAA,CAACvB,EAAMuB,CAAQ,EACV,OAAA,KAAK,MAAMA,CAAQ,EAG5B,MAAMK,EAAW,MAAM,MACrB,GAAGC,EACDtB,EAAY,OAAA,iBACGE,iCACjB,CACE,OAAQ,OACR,KAAMc,EACN,QAASO,EAAwB,MAAMvB,EAAY,gBAAgB,CACrE,CAAA,EAGE,GAAA,CAACqB,EAAS,GACZ,MAAM,IAAI,MACR,yCAAyCA,EAAS,YAAA,EAItD,OAAOA,EAAS,MAClB,CAEM,MAAAG,EAAO,MAAOC,GAAiC,CAC/C,GAAA,CACF,MAAMC,EAAY,MAAM1B,EAAY,QAAQ,OAAO,CACjD,GAAGS,EACH,GAAGkB,EAA0B,CAC3B,GAAGF,EACH,WAAYA,EAAO,YAAc,CAAC,CAAA,CACnC,CAAA,CACF,EACDb,EAAShB,EAAE,qBAAqB,EAAGgC,EAAa,OAAO,EAC9C9B,EAAA+B,EAAS,CAAE,MAAA3B,EAAO,SAAUwB,EAAU,GAAI,IAAK,UAAY,CAAA,CAAC,QAC9DN,GACPP,EAAS,4BAA6BO,CAAK,CAC7C,CAAA,EAGF,OAEIU,EAAA,KAAAC,WAAA,CAAA,SAAA,CAAAC,EAAA,IAACC,EAAA,CACC,SAAS,uBACT,OAAO,wBAAA,CACT,EACAD,EAAAA,IAACE,EAAY,CAAA,QAAQ,QACnB,SAAAF,EAAA,IAACG,EAAA,CACC,aAAY,GACZ,SAAU5B,EAAaiB,CAAI,EAC3B,KAAK,iBAEL,SAAAM,EAAAA,KAACM,EAAc,CAAA,GAAGhC,EAChB,SAAA,CAAA4B,EAAA,IAACK,EAAA,CACC,GAAG,aACH,SAAUC,EAAS,KACnB,UAAU,aACV,SAAU1C,EAAE,kCAAkC,EAC9C,SAAUmB,CAAA,CACZ,EACAiB,EAAAA,IAACO,EAAkB,CAAA,mBAAkB,EAAC,CAAA,QACrCC,EAAU,CAAA,MAAO5C,EAAE,aAAa,EAAG,QAAQ,UAC1C,SAAAoC,EAAA,IAACS,EAAA,CACC,GAAG,UACH,WAAU,GACT,GAAGnC,EAAS,UAAU,CAAA,CAAA,EAE3B,EACA0B,EAAAA,IAACU,EAAiB,CAAA,OAAQ,EAAM,CAAA,SAC/BC,EACC,CAAA,SAAA,CAAAX,EAAAA,IAACY,GAAO,QAAQ,UAAU,KAAK,SAC5B,SAAAhD,EAAE,aAAa,EAClB,EACAoC,EAAA,IAACY,EAAA,CACC,QAAQ,OACR,UAAYC,GACVb,EAAA,IAACc,EAAM,CAAA,GAAGD,EAAO,GAAIE,EAAU,CAAE,MAAA7C,CAAM,CAAC,CAAG,CAAA,EAG5C,WAAE,eAAe,CAAA,CACpB,CAAA,EACF,CAAA,EACF,CAAA,CAAA,EAEJ,CACF,CAAA,CAAA,CAEJ"}