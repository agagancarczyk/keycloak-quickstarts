import{bp as Ve,c1 as ss,c2 as ts,c5 as Ne,c4 as rs,c3 as as,bj as ns,c6 as Ue,bi as is,cx as os,bg as ds,dq as ls,dr as cs,ds as us,dt as ms,du as ps,dv as hs,u as R,d as G,e as _,r as y,f as de,j as e,P as ne,bE as Se,b3 as fs,aB as gs,A as M,k as te,a8 as V,a2 as qe,F as se,V as q,G as Le,C as He,S as xs,a as bs,N as ys,g as ze,B as A,dw as js,dx as Cs,D as ws,bF as vs,a7 as Is,w as Pe,n as De,X as _e,U as ks,as as Ke,W as Ps,az as We,J as Ts,c as Ce,R as Ss,K as xe,aZ as Ls,L as Ds,bL as Fs,E as Be,b as Rs,dy as As,aN as Es}from"./index-a3421f29.js";import{u as ie,C as $e}from"./ConfirmDialog-09ff7a12.js";import{R as Ns,u as Us}from"./RoutableTabs-7f56b0c5.js";import{V as Ks}from"./ViewHeader-832ec56e.js";import{u as Bs,U as Ms}from"./UserProfileContext-1adc9dc8.js";import{u as Fe}from"./useParams-5abeab7d.js";import{A as Gs}from"./AttributeForm-1b8e495d.js";import{L as Re}from"./PaginatingTableToolbar-08ca9efb.js";import{K as je,P as Os,T as Vs,l as qs,m as Hs}from"./KeycloakDataTable-10a62d94.js";import{u as zs}from"./useFormatDate-7fddef56.js";import{X as _s,N as B,Y as Ws,P as U,R as Xe,S as Je,O as me,U as W,T as Ye,V as ke}from"./Td-6d4ab209.js";import{C as $s,S as Xs}from"./SessionsTable-69066f36.js";import{C as Js,c as Ys}from"./Select-0f56a9cc.js";import{P as Me}from"./PasswordInput-85f9399f.js";import{u as Te}from"./useToggle-a9cb2c55.js";import{F as we}from"./Form-518a2cf2.js";import{R as Qs,F as Zs,U as et,i as st,u as tt}from"./UserForm-4d660c10.js";import{T as rt}from"./TimeSelector-a2bc30e2.js";import{a as Ae,M as Qe}from"./Modal-21c37af7.js";import{K as ye}from"./KeycloakTextInput-e7f6e917.js";import{u as at}from"./useLocaleSort-3efc7c31.js";import{G as nt,a as it}from"./GroupPickerDialog-caf8c38d.js";import{C as ot}from"./Checkbox-d00621d8.js";import{Q as dt}from"./question-circle-icon-45a94074.js";import{F as Ge}from"./FormPanel-11cb7e22.js";import{c as pe}from"./capitalize-e93b891e.js";import{T as be}from"./Text-564bf299.js";import{R as lt}from"./AddRoleMappingModal-abb19beb.js";import"./user-section-4ed993c7.js";import{a as Z,b as ee}from"./Tabs-5beaba80.js";import"./ToolbarContent-7b435752.js";import"./FormAccess-1cceaef6.js";import"./copy-icon-a4fe01af.js";import"./GridItem-d34dae2e.js";import"./KeyValueInput-ce08b760.js";import"./minus-icon-16876c86.js";import"./minus-circle-icon-6f9a971c.js";import"./ActionListItem-ab1a4322.js";import"./plus-circle-icon-cb854796.js";import"./EmptyStateBody-7b4fcee1.js";import"./EmptyStateSecondaryActions-08edafb5.js";import"./TableToolbar-ee0c86ef.js";import"./star-icon-6a7e7d25.js";import"./check-fc57dbe1.js";import"./grip-vertical-icon-cbeff50f.js";import"./ListItem-499ec6f9.js";import"./useIsFeatureEnabled-1df1a04b.js";import"./ScrollForm-a21fd695.js";import"./DataListItemRow-75e02946.js";import"./data-list-7d55714c.js";import"./CardHeader-457352d1.js";import"./Card-aa3ba03c.js";import"./CardTitle-9175b04a.js";import"./CardBody-519f6395.js";import"./resource-08ae7dbc.js";import"./joinPath-55fd24bc.js";import"./filter-icon-9d72dc58.js";import"./plus-icon-2a767bad.js";import"./MenuList-e3786b59.js";var ct=Math.min;function ut(s,t,n){for(var o=n?rs:as,a=s[0].length,m=s.length,l=m,c=Array(m),u=1/0,p=[];l--;){var x=s[l];l&&t&&(x=Ve(x,ss(t))),u=ct(x.length,u),c[l]=!n&&(t||a>=120&&x.length>=120)?new ts(l&&x):void 0}x=s[0];var i=-1,d=c[0];e:for(;++i<a&&p.length<u;){var b=x[i],g=t?t(b):b;if(b=n||b!==0?b:0,!(d?Ne(d,g):o(p,g,n))){for(l=m;--l;){var F=c[l];if(!(F?Ne(F,g):o(s[l],g,n)))continue e}d&&d.push(g),p.push(b)}}return p}function mt(s){return _s(s)?s:[]}var pt=ns(function(s){var t=Ue(s),n=Ve(s,mt);return t===Ue(n)?t=void 0:n.pop(),n.length&&n[0]===s[0]?ut(n,is(t)):[]});const ht=pt;var ft="[object Map]",gt="[object Set]",xt=Object.prototype,bt=xt.hasOwnProperty;function Oe(s){if(s==null)return!0;if(os(s)&&(ds(s)||typeof s=="string"||typeof s.splice=="function"||ls(s)||cs(s)||us(s)))return!s.length;var t=ms(s);if(t==ft||t==gt)return!s.size;if(ps(s))return!hs(s).length;for(var n in s)if(bt.call(s,n))return!1;return!0}const yt=({user:s})=>{const{t}=R("users"),{adminClient:n}=G(),{addAlert:o,addError:a}=_(),[m,l]=y.useState(s),c=de({mode:"onChange"}),{config:u}=Bs(),p=()=>fs(m.attributes).filter(i=>!u?.attributes?.some(d=>d.name===i.key));y.useEffect(()=>{c.setValue("attributes",p())},[m,u]);const x=async i=>{try{const d=gs(i.attributes);await n.users.update({id:m.id},{...m,attributes:d}),l({...m,attributes:d}),o(t("userSaved"),M.success)}catch(d){a("groups:groupUpdateError",d)}};return e.jsx(ne,{variant:Se.light,children:e.jsx(Gs,{form:c,save:x,fineGrainedAccess:m.access?.manage,reset:()=>c.reset({attributes:p()})})})},jt=()=>{const[s,t]=y.useState(),{t:n}=R("roles"),{addAlert:o,addError:a}=_(),m=zs(),[l,c]=y.useState(0),{adminClient:u}=G(),{id:p}=Fe(),x=I=>qe(I,K=>K.clientId?.toUpperCase()),i=()=>c(new Date().getTime()),d=async()=>{const I=await u.users.listConsents({id:p});return x(I)},b=({grantedClientScopes:I})=>e.jsx(Js,{className:"kc-consents-chip-group",children:I.map(K=>e.jsx(Ys,{isReadOnly:!0,className:"kc-consents-chip",id:"consents-chip-text",children:K},K))}),[g,F]=ie({titleKey:"users:revokeClientScopesTitle",messageKey:n("users:revokeClientScopes",{clientId:s?.clientId}),continueButtonLabel:"common:revoke",continueButtonVariant:te.danger,onConfirm:async()=>{try{await u.users.revokeConsent({id:p,clientId:s.clientId}),i(),o(n("deleteGrantsSuccess"),M.success)}catch(I){a("roles:deleteGrantsError",I)}}});return e.jsxs(e.Fragment,{children:[e.jsx(F,{}),e.jsx(je,{loader:d,ariaLabelKey:"roles:roleList",searchPlaceholderKey:" ",columns:[{name:"clientId",displayKey:"clients:Client",cellFormatters:[V()],transforms:[B(20)]},{name:"grantedClientScopes",displayKey:"client-scopes:grantedClientScopes",cellFormatters:[V()],cellRenderer:b,transforms:[B(30)]},{name:"createDate",displayKey:"clients:created",transforms:[B(20)],cellRenderer:({createDate:I})=>I?m(new Date(I)):"—"},{name:"lastUpdatedDate",displayKey:"clients:lastUpdated",transforms:[B(10)],cellRenderer:({lastUpdatedDate:I})=>I?m(new Date(I)):"—"}],actions:[{title:n("users:revoke"),onRowClick:I=>{t(I),g()}}],emptyState:e.jsx(Re,{hasIcon:!0,icon:$s,message:n("users:noConsents"),instructions:n("users:noConsentsText")})},l)]})},Ct={password:"",passwordConfirmation:"",temporaryPassword:!0},wt=({user:s,isResetPassword:t,refresh:n,onClose:o})=>{const{t:a}=R("users"),{register:m,control:l,formState:{isValid:c,errors:u},watch:p,handleSubmit:x}=de({defaultValues:Ct,mode:"onChange"}),[i,d]=Te(!0),b=p("password",""),{adminClient:g}=G(),{addAlert:F,addError:I}=_(),[K,$]=ie({titleKey:t?"users:resetPasswordConfirm":"users:setPasswordConfirm",messageKey:t?a("resetPasswordConfirmText",{username:s.username}):a("setPasswordConfirmText",{username:s.username}),continueButtonLabel:t?"users:resetPassword":"users:savePassword",continueButtonVariant:te.danger,onConfirm:()=>x(X)()}),X=async({password:S,temporaryPassword:H})=>{try{await g.users.resetPassword({id:s.id,credential:{temporary:H,type:"password",value:S}});const L=(await g.users.getCredentials({id:s.id})).find(O=>O.type==="password");L&&await g.users.updateCredentialLabel({id:s.id,credentialId:L.id},a("defaultPasswordLabel")),F(a(t?"resetCredentialsSuccess":"savePasswordSuccess"),M.success),n()}catch(D){I(t?"users:resetPasswordError":"users:savePasswordError",D)}o()};return e.jsxs(e.Fragment,{children:[e.jsx($,{}),e.jsx($e,{titleKey:t?a("resetPasswordFor",{username:s.username}):a("setPasswordFor",{username:s.username}),open:i,onCancel:o,toggleDialog:d,onConfirm:K,confirmButtonDisabled:!c,continueButtonLabel:"common:save",children:e.jsxs(we,{id:"userCredentials-form",isHorizontal:!0,className:"keycloak__user-credentials__reset-form",children:[e.jsx(se,{name:"password",label:a("password"),fieldId:"password",helperTextInvalid:a("common:required"),validated:u.password?q.error:q.default,isRequired:!0,children:e.jsx(Me,{"data-testid":"passwordField",id:"password",...m("password",{required:!0})})}),e.jsx(se,{name:"passwordConfirmation",label:a(t?"resetPasswordConfirmation":"passwordConfirmation"),fieldId:"passwordConfirmation",helperTextInvalid:u.passwordConfirmation?.message,validated:u.passwordConfirmation?q.error:q.default,isRequired:!0,children:e.jsx(Me,{"data-testid":"passwordConfirmationField",id:"passwordConfirmation",...m("passwordConfirmation",{required:!0,validate:S=>S===b||a("confirmPasswordDoesNotMatch").toString()})})}),e.jsx(se,{label:a("common:temporaryPassword"),labelIcon:e.jsx(Le,{helpText:a("temporaryPasswordHelpText"),fieldLabelId:"temporaryPassword"}),fieldId:"kc-temporaryPassword",children:e.jsx(He,{name:"temporaryPassword",defaultValue:!0,control:l,render:({field:S})=>e.jsx(xs,{className:"kc-temporaryPassword",onChange:S.onChange,isChecked:S.value,label:a("common:on"),labelOff:a("common:off"),"aria-label":a("common:temporaryPassword")})})})]})})]})},vt=()=>{const{t:s}=R("users"),{control:t}=bs();return e.jsx(se,{fieldId:"lifespan",label:s("lifespan"),isStack:!0,labelIcon:e.jsx(Le,{helpText:s("clients-help:lifespan"),fieldLabelId:"lifespan"}),children:e.jsx(He,{name:"lifespan",defaultValue:Ze.lifespan,control:t,render:({field:n})=>e.jsx(rt,{value:n.value,units:["minute","hour","day"],onChange:n.onChange,menuAppendTo:"parent"})})})},Ze={actions:[],lifespan:43200},It=({userId:s,onClose:t})=>{const{t:n}=R("users"),o=de({defaultValues:Ze}),{handleSubmit:a,control:m}=o,l=ys({control:m,name:"actions"}),c=!Oe(l),{adminClient:u}=G(),{addAlert:p,addError:x}=_(),i=async({actions:d,lifespan:b})=>{if(!Oe(d))try{await u.users.executeActionsEmail({id:s,actions:d,lifespan:b}),p(n("credentialResetEmailSuccess"),M.success),t()}catch(g){x("users:credentialResetEmailError",g)}};return e.jsx($e,{variant:Ae.medium,titleKey:"users:credentialReset",open:!0,onCancel:t,toggleDialog:t,continueButtonLabel:"users:credentialResetConfirm",onConfirm:()=>{a(i)()},confirmButtonDisabled:!c,children:e.jsx(we,{id:"userCredentialsReset-form",isHorizontal:!0,"data-testid":"credential-reset-modal",children:e.jsxs(ze,{...o,children:[e.jsx(Qs,{name:"actions",label:"resetActions",help:"clients-help:resetActions"}),e.jsx(vt,{})]})})})},kt=({userId:s,credential:t,isEditable:n,toggle:o})=>{const{t:a}=R("users"),{register:m,handleSubmit:l}=de(),{adminClient:c}=G(),{addAlert:u,addError:p}=_(),x=async i=>{try{await c.users.updateCredentialLabel({id:s,credentialId:t.id},i.userLabel||""),u(a("updateCredentialUserLabelSuccess"),M.success),o()}catch(d){p("users:updateCredentialUserLabelError",d)}};return e.jsx(we,{isHorizontal:!0,className:"kc-form-userLabel",onSubmit:l(x),children:e.jsx(se,{fieldId:"kc-userLabel",className:"kc-userLabel-row",children:e.jsx("div",{className:"kc-form-group-userLabel",children:n?e.jsxs(e.Fragment,{children:[e.jsx(ye,{"data-testid":"userLabelFld",defaultValue:t.userLabel,className:"kc-userLabel","aria-label":a("userLabel"),...m("userLabel")}),e.jsxs("div",{className:"kc-userLabel-actionBtns",children:[e.jsx(A,{"data-testid":"editUserLabelAcceptBtn",variant:"link",className:"kc-editUserLabelAcceptBtn",type:"submit",icon:e.jsx(js,{})}),e.jsx(A,{"data-testid":"editUserLabelCancelBtn",variant:"link",className:"kc-editUserLabel-cancelBtn",onClick:o,icon:e.jsx(Cs,{})})]})]}):e.jsxs(e.Fragment,{children:[t.userLabel,e.jsx(A,{"aria-label":a("editUserLabel"),variant:"link",className:"kc-editUserLabel-btn",onClick:o,"data-testid":"editUserLabelBtn",icon:e.jsx(Os,{})})]})})})})},Pt=({credentialData:s,onClose:t})=>{const{t:n}=R("users");return e.jsx(Qe,{variant:Ae.medium,title:n("passwordDataTitle"),"data-testid":"passwordDataDialog",isOpen:!0,onClose:t,children:e.jsxs(Vs,{"aria-label":n("passwordDataTitle"),"data-testid":"password-data-dialog",variant:Ws.compact,cells:[n("showPasswordDataName"),n("showPasswordDataValue")],rows:s,children:[e.jsx(qs,{}),e.jsx(Hs,{})]})})},Tt=({credential:s,resetPassword:t,toggleDelete:n,children:o})=>{const{t:a}=R("users"),[m,l]=Te(),[c,u]=Te(),p=at(),x=y.useMemo(()=>{if(!s.credentialData)return[];const i=JSON.parse(s.credentialData);return p(Object.entries(i),([d])=>d).map(([d,b])=>typeof b=="string"?[d,b]:[d,JSON.stringify(b)])},[s.credentialData]);return e.jsxs(e.Fragment,{children:[m&&Object.keys(s).length!==0&&e.jsx(Pt,{credentialData:x,onClose:()=>{l()}}),e.jsx(U,{children:o}),e.jsx(U,{children:e.jsx(A,{className:"kc-showData-btn",variant:"link","data-testid":"showDataBtn",onClick:l,children:a("showDataBtn")})}),s.type==="password"?e.jsx(U,{isActionCell:!0,children:e.jsx(A,{variant:"secondary","data-testid":"resetPasswordBtn",onClick:t,children:a("resetPasswordBtn")})}):e.jsx(U,{}),e.jsx(U,{isActionCell:!0,children:e.jsx(ws,{isPlain:!0,position:vs.right,toggle:e.jsx(Is,{onToggle:u}),isOpen:c,dropdownItems:[e.jsx(Pe,{"data-testid":"deleteDropdownItem",component:"button",onClick:()=>{n(),u()},children:a("deleteBtn")},s.id)]})})]})};const St=({user:s,onSetPassword:t})=>{const{t:n}=R("users"),{adminClient:o}=G(),[a,m]=y.useState();return De(()=>o.users.getUserStorageCredentialTypes({id:s.id}),m,[]),a?e.jsx(ne,{variant:Se.light,children:e.jsxs(Xe,{variant:"compact",children:[e.jsx(Je,{children:e.jsxs(me,{children:[e.jsx(W,{children:n("type")}),e.jsx(W,{children:n("providedBy")}),e.jsx(W,{})]})}),e.jsx(Ye,{children:a.map(l=>e.jsxs(me,{children:[e.jsx(U,{children:e.jsx("b",{children:l})}),e.jsx(U,{children:e.jsx(Zs,{user:s})}),l==="password"&&e.jsx(U,{modifier:"fitContent",children:e.jsx(A,{variant:"secondary",onClick:t,children:n("setPassword")})})]},l))})]})}):e.jsx(_e,{})},Lt=({user:s})=>{const{t}=R("users"),{addAlert:n,addError:o}=_(),[a,m]=y.useState(0),l=()=>m(a+1),[c,u]=y.useState(!1),[p,x]=y.useState(!1),{adminClient:i}=G(),[d,b]=y.useState([]),[g,F]=y.useState([]),[I,K]=y.useState({}),[$,X]=y.useState(!1),[S,H]=y.useState(),D=y.useRef(null),[L,O]=y.useState({draggedItemId:"",draggingToItemIndex:-1,dragging:!1,tempItemOrder:[""]});De(()=>i.users.getCredentials({id:s.id}),r=>{b(r);const w=r.reduce((v,T)=>(v[T.type]=v[T.type]||[],v[T.type].push(T),v),Object.create(null)),C=Object.keys(w).map(v=>({key:v,value:w[v]}));F(C.map(v=>({...v,isExpanded:!1})))},[a]);const P=d.find(r=>r.type==="password"),h=()=>u(!c),E=()=>{x(!p)},j=()=>{X(!0),h()},[J,re]=ie({titleKey:t("deleteCredentialsConfirmTitle"),messageKey:t("deleteCredentialsConfirm"),continueButtonLabel:t("common:delete"),continueButtonVariant:te.danger,onConfirm:async()=>{try{await i.users.deleteCredential({id:s.id,credentialId:I.id}),n(t("deleteCredentialsSuccess"),M.success),m(r=>r+1)}catch(r){o("users:deleteCredentialsError",r)}}}),ae=({credential:r})=>e.jsx(Tt,{credential:r,toggleDelete:()=>{K(r),J()},resetPassword:j,children:e.jsx(kt,{credential:r,userId:s.id,isEditable:S?.status&&S.rowKey===r.id||!1,toggle:()=>{H({status:!S?.status,rowKey:r.id}),S?.status&&l()}})},r.id),Q=y.useMemo(()=>g.flatMap(r=>[r.value.map(({id:w})=>w).toString(),...r.isExpanded?r.value.map(w=>w.id):[]]),[g]),le=r=>{r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("text/plain",r.currentTarget.id);const w=r.currentTarget.id;r.currentTarget.classList.add(ke.modifiers.ghostRow),r.currentTarget.setAttribute("aria-pressed","true"),O({...L,draggedItemId:w,dragging:!0})},he=(r,w,C)=>{const v=r.indexOf(w);if(v===C)return r;const T=[...r];return T.splice(C,0,T.splice(v,1)[0]),T},fe=r=>{if(!D.current)return;const w=D.current,C=Array.from(w.children);C.every(({id:v},T)=>v===r[T])||(w.replaceChildren(),r.forEach(v=>{w.appendChild(C.find(({id:T})=>T===v))}))},ve=()=>{D.current&&(Array.from(D.current.children).forEach(r=>{r.classList.remove(ke.modifiers.ghostRow),r.setAttribute("aria-pressed","false")}),O({...L,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},ge=r=>{ce(r)||(fe(Q),O({...L,draggingToItemIndex:-1}))},ce=r=>{if(!D.current)return!1;const w=D.current.getBoundingClientRect();return r.clientX>w.x&&r.clientX<w.x+w.width&&r.clientY>w.y&&r.clientY<w.y+w.height},ue=r=>{ce(r)?Ie(L.draggedItemId,L.tempItemOrder):ve()},Y=r=>{r.preventDefault();const C=r.target.closest("tr");if(!(!C||D.current&&!D.current.contains(C)||C.id===L.draggedItemId)){const v=C.id,T=Array.from(D.current?.children||[]).findIndex(k=>k.id===v);if(T===L.draggingToItemIndex)return;const f=he(Q,L.draggedItemId,T);fe(f),O({...L,draggingToItemIndex:T,tempItemOrder:f})}},oe=({target:r})=>{r instanceof HTMLTableRowElement&&(r.classList.remove(ke.modifiers.ghostRow),r.setAttribute("aria-pressed","false"),O({...L,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},Ie=async(r,w)=>{const C=Q.findIndex(k=>k===r),v=w.findIndex(k=>k===r),T=v-C,f=r.split(",");try{for(const k of f)for(let N=0;N<Math.abs(T);N++)T>0?await i.users.moveCredentialPositionDown({id:s.id,credentialId:k,newPreviousCredentialId:Q[v]}):await i.users.moveCredentialPositionUp({id:s.id,credentialId:k});l(),n(t("users:updatedCredentialMoveSuccess"),M.success)}catch(k){o("users:updatedCredentialMoveError",k)}};return e.jsxs(e.Fragment,{children:[c&&e.jsx(wt,{user:s,isResetPassword:$,refresh:l,onClose:()=>u(!1)}),p&&e.jsx(It,{userId:s.id,onClose:()=>x(!1)}),e.jsx(re,{}),s.email&&e.jsx(A,{className:"kc-resetCredentialBtn-header",variant:"primary","data-testid":"credentialResetBtn",onClick:()=>x(!0),children:t("credentialResetBtn")}),d.length!==0&&P===void 0&&e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"kc-setPasswordBtn-tbl","data-testid":"setPasswordBtn-table",variant:"primary",form:"userCredentials-form",onClick:()=>{u(!0)},children:t("setPassword")}),e.jsx(ks,{})]}),g.length!==0&&e.jsx(ne,{variant:Se.light,children:e.jsxs(Xe,{variant:"compact",children:[e.jsx(Je,{children:e.jsxs(me,{className:"kc-table-header",children:[e.jsx(W,{children:e.jsx(Le,{helpText:t("users:userCredentialsHelpText"),fieldLabelId:"users:userCredentialsHelpTextLabel"})}),e.jsx(W,{}),e.jsx(W,{children:t("type")}),e.jsx(W,{children:t("userLabel")}),e.jsx(W,{children:t("data")}),e.jsx(W,{}),e.jsx(W,{})]})}),e.jsx(Ye,{ref:D,onDragOver:Y,onDrop:Y,onDragLeave:ge,children:g.map((r,w)=>e.jsxs(y.Fragment,{children:[e.jsxs(me,{id:r.value.map(({id:C})=>C).toString(),draggable:g.length>1,onDrop:ue,onDragEnd:oe,onDragStart:le,children:[e.jsx(U,{className:g.length===1?"one-row":"",draggableRow:{id:`draggable-row-${r.value.map(({id:C})=>C)}`}}),r.value.length>1?e.jsx(U,{className:"kc-expandRow-btn",expand:{rowIndex:w,isExpanded:r.isExpanded,onToggle:(C,v)=>{const T=g.map((f,k)=>k===v?{...f,isExpanded:!f.isExpanded}:f);F(T)}}}):e.jsx(U,{}),e.jsx(U,{dataLabel:`columns-${r.key}`,className:"kc-notExpandableRow-credentialType","data-testid":"credentialType",children:Ke(r.key)}),r.value.length<=1&&r.value.map(C=>e.jsx(ae,{credential:C},C.id))]}),r.isExpanded&&r.value.map(C=>e.jsxs(me,{id:C.id,draggable:!0,onDrop:ue,onDragEnd:oe,onDragStart:le,children:[e.jsx(U,{}),e.jsx(U,{className:"kc-draggable-dropdown-type-icon",draggableRow:{id:`draggable-row-${r.value.map(({id:v})=>v)}`}}),e.jsx(U,{dataLabel:`child-columns-${C.id}`,className:"kc-expandableRow-credentialType",children:Ke(C.type)}),e.jsx(ae,{credential:C})]},C.id))]},r.key))})]})}),(s.federationLink||s.origin)&&e.jsx(St,{user:s,onSetPassword:h}),g.length===0&&!(s.federationLink||s.origin)&&e.jsx(Re,{hasIcon:!0,message:t("noCredentials"),instructions:t("noCredentialsText"),primaryActionText:t("setPassword"),onPrimaryAction:h,secondaryActions:s.email?[{text:t("credentialResetBtn"),onClick:E,type:te.link}]:void 0})]})},Dt=({user:s})=>{const{t}=R("users"),{addAlert:n,addError:o}=_(),[a,m]=y.useState(0),l=()=>m(new Date().getTime()),[c,u]=y.useState([]),[p,x]=y.useState(""),[i,d]=y.useState(!0),[b,g]=y.useState([]),[F,I]=y.useState(!1),{enabled:K}=Ps(),{hasAccess:$}=We(),X=$("manage-users"),{adminClient:S}=G(),H=j=>qe(j,J=>J.path?.toUpperCase()),D=async(j,J,re)=>{const ae={first:j,max:J},Q=re||"";Q&&(ae.search=Q,x(Q));const le=await S.users.listGroups({...ae,id:s.id}),he=await S.groups.find(),fe=le.reduce((f,k)=>(k.path&&f.push(k.path),f),[]),ve=[],ge=[],ce=[],ue=[...he];let Y=[];const oe=(f,k,N)=>{if(k(f,N),typeof f!="object")return N;if(Array.isArray(f))return f.forEach(z=>oe(z,k,N)),N;for(const z in f)oe(f[z],k,N);return N},Ie=oe(ue,(f,k)=>{f?.subGroups&&k.push(f.subGroups)},[]),r=[].concat(...Ie);Y=[...ue,...r],fe.forEach(f=>{const k=f.split("/"),N=[];k.reduce((z,es)=>{const Ee=z+"/"+es;return N.push(Ee),Ee},"");for(let z=1;z<N.length;z++)ce.push(N[z].substring(1))}),ge.push(...ce),Y.forEach(f=>{f.subGroups.length!==0&&Y.push(...f.subGroups)}),Y=Y.filter(f=>ge.includes(f.path));const w=he.filter(f=>ve.includes(f.name)),C=[];w.forEach(f=>C.push(f.subGroups));const v=le.filter(f=>!w.includes(f));g(v);const T=Y.filter((f,k,N)=>k===N.findIndex(z=>z.name===f.name));return H(i?v:T)};y.useEffect(()=>{l()},[i]);const L=()=>{I(!F)},[O,P]=ie({titleKey:t("leaveGroup",{count:c.length,name:c[0]?.name}),messageKey:t("leaveGroupConfirmDialog",{count:c.length,groupname:c[0]?.name,username:s.username}),continueButtonLabel:"leave",continueButtonVariant:te.danger,onConfirm:async()=>{try{await Promise.all(c.map(j=>S.users.delFromGroup({id:s.id,groupId:j.id}))),l(),n(t("removedGroupMembership"),M.success)}catch(j){o("users:removedGroupMembershipError",j)}}}),h=j=>{u(j),O()},E=async j=>{j.forEach(async re=>{try{await S.users.addToGroup({id:s.id,groupId:re.id}),l(),n(t("addedGroupMembership"),M.success)}catch(ae){o("users:addedGroupMembershipError",ae)}})};return e.jsxs(e.Fragment,{children:[e.jsx(P,{}),F&&e.jsx(nt,{id:s.id,type:"selectMany",text:{title:t("joinGroupsFor",{username:s.username}),ok:"users:join"},canBrowse:X,onClose:()=>I(!1),onConfirm:j=>{E(j||[]),I(!1),l()}}),e.jsx(je,{loader:D,className:"keycloak_user-section_groups-table",isPaginated:!0,ariaLabelKey:"roles:roleList",searchPlaceholderKey:"groups:searchGroup",canSelectAll:!0,onSelect:j=>u(i?j:ht(j,b,"id")),isRowDisabled:j=>!i&&b.every(J=>J.id!==j.id),toolbarItem:e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"kc-join-group-button",onClick:L,"data-testid":"add-group-button",isDisabled:!s.access?.manageGroupMembership,children:t("joinGroup")}),e.jsx(ot,{label:t("directMembership"),id:"kc-direct-membership-checkbox",onChange:()=>d(!i),isChecked:i,className:"direct-membership-check"},"direct-membership-check"),e.jsx(A,{onClick:()=>h(c),"data-testid":"leave-group-button",variant:"link",isDisabled:c.length===0,children:t("leave")}),K&&e.jsx(Ts,{"aria-label":"Basic popover",position:"bottom",bodyContent:e.jsx("div",{children:t("whoWillAppearPopoverText")}),children:e.jsx(A,{variant:"link",className:"kc-who-will-appear-button",icon:e.jsx(dt,{}),children:t("whoWillAppearLinkText")},"who-will-appear-button")})]}),columns:[{name:"groupMembership",displayKey:"users:groupMembership",cellRenderer:j=>j.name||"",cellFormatters:[V()],transforms:[B(40)]},{name:"path",displayKey:"users:path",cellRenderer:j=>e.jsx(it,{group:j}),transforms:[B(45)]},{name:"",cellRenderer:j=>b.some(re=>re.id===j.id)||b.length===0||i?e.jsx(A,{"data-testid":`leave-${j.name}`,onClick:()=>h([j]),variant:"link",isDisabled:!s.access?.manageGroupMembership,children:t("leave")}):"",cellFormatters:[V()],transforms:[B(20)]}],emptyState:p?"":e.jsx(Re,{hasIcon:!0,message:t("noGroups"),instructions:t("noGroupsText"),primaryActionText:t("joinGroup"),onPrimaryAction:L})},a)]})},Ft=({userId:s,federatedId:t,onClose:n,onRefresh:o})=>{const{t:a}=R("users"),{adminClient:m}=G(),{addAlert:l,addError:c}=_(),{register:u,handleSubmit:p,formState:{isValid:x,errors:i}}=de({mode:"onChange"}),d=async b=>{try{await m.users.addToFederatedIdentity({id:s,federatedIdentityId:t,federatedIdentity:b}),l(a("users:idpLinkSuccess"),M.success),n(),o()}catch(g){c("users:couldNotLinkIdP",g)}};return e.jsx(Qe,{variant:Ae.small,title:a("users:linkAccountTitle",{provider:pe(t)}),onClose:n,actions:[e.jsx(A,{"data-testid":"confirm",variant:"primary",type:"submit",form:"group-form",isDisabled:!x,children:a("link")},"confirm"),e.jsx(A,{"data-testid":"cancel",variant:te.link,onClick:n,children:a("common:cancel")},"cancel")],isOpen:!0,children:e.jsxs(we,{id:"group-form",onSubmit:p(d),children:[e.jsx(se,{label:a("users:identityProvider"),fieldId:"identityProvider",children:e.jsx(ye,{id:"identityProvider","data-testid":"idpNameInput",value:pe(t),isReadOnly:!0})}),e.jsx(se,{label:a("users:userID"),fieldId:"userID",helperText:a("users-help:userIdHelperText"),helperTextInvalid:a("common:required"),validated:i.userId?q.error:q.default,isRequired:!0,children:e.jsx(ye,{id:"userID","data-testid":"userIdInput",validated:i.userId?q.error:q.default,autoFocus:!0,...u("userId",{required:!0})})}),e.jsx(se,{label:a("users:username"),fieldId:"username",helperText:a("users-help:usernameHelperText"),helperTextInvalid:a("common:required"),validated:i.userName?q.error:q.default,isRequired:!0,children:e.jsx(ye,{id:"username","data-testid":"usernameInput",validated:i.userName?q.error:q.default,...u("userName",{required:!0})})})]})})},Rt=({userId:s})=>{const[t,n]=y.useState(0),[o,a]=y.useState(""),[m,l]=y.useState(!1),{adminClient:c}=G(),{realm:u}=Ce(),{addAlert:p,addError:x}=_(),{t:i}=R("users"),d=()=>n(new Date().getTime()),b=Ss().identityProviders,g=async()=>{const P=await c.identityProviders.find(),h=await c.users.listFederatedIdentities({id:s});for(const E of h)E.providerId=P.find(j=>j.alias===E.identityProvider)?.providerId;return h},F=async()=>(await c.realms.findOne({realm:u})).identityProviders,I=async()=>g(),K=async()=>{const P=(await g()).map(h=>h.identityProvider);return(await F())?.filter(h=>!P.includes(h.alias))},[$,X]=ie({titleKey:i("users:unlinkAccountTitle",{provider:pe(o)}),messageKey:i("users:unlinkAccountConfirm",{provider:pe(o)}),continueButtonLabel:"users:unlink",continueButtonVariant:te.primary,onConfirm:async()=>{try{await c.users.delFromFederatedIdentity({id:s,federatedIdentityId:o}),p(i("users:idpUnlinkSuccess"),M.success),d()}catch(P){x("common:mappingDeletedError",P)}}}),S=P=>e.jsx(Ds,{to:Fs({realm:u,providerId:P.providerId,alias:P.identityProvider,tab:"settings"}),children:pe(P.identityProvider)}),H=P=>{const h=b?.find(E=>E.id===P.identityProvider)?.groupName;return e.jsx(Be,{color:h==="Social"?"blue":"orange",children:i(h==="Social"?"users:idpType.social":"users:idpType.custom")})},D=P=>{const h=b?.find(E=>E.id===P.providerId)?.groupName;return e.jsx(Be,{color:h==="User-defined"?"orange":"blue",children:h==="User-defined"?"Custom":h==="Social"?i("users:idpType.social"):h})},L=P=>e.jsx(A,{variant:"link",onClick:()=>{a(P.identityProvider),$()},children:i("unlinkAccount")}),O=P=>e.jsx(A,{variant:"link",onClick:()=>{a(P.alias),l(!0)},children:i("linkAccount")});return e.jsxs(e.Fragment,{children:[m&&e.jsx(Ft,{userId:s,federatedId:o,onClose:()=>l(!1),onRefresh:d}),e.jsx(X,{}),e.jsxs(ne,{variant:"light",className:"pf-u-p-0",children:[e.jsxs(Ge,{title:i("linkedIdPs"),className:"kc-linked-idps",children:[e.jsx(xe,{children:e.jsx(be,{className:"kc-available-idps-text",children:i("linkedIdPsText")})}),e.jsx(je,{loader:I,isPaginated:!1,ariaLabelKey:"users:LinkedIdPs",className:"kc-linked-IdPs-table",columns:[{name:"identityProvider",displayKey:"common:name",cellFormatters:[V()],cellRenderer:S,transforms:[B(20)]},{name:"type",displayKey:"common:type",cellFormatters:[V()],cellRenderer:H,transforms:[B(10)]},{name:"userId",displayKey:"users:userID",cellFormatters:[V()],transforms:[B(30)]},{name:"userName",displayKey:"users:username",cellFormatters:[V()],transforms:[B(20)]},{name:"",cellFormatters:[V()],cellRenderer:L,transforms:[B(20)]}],emptyState:e.jsx(xe,{className:"kc-no-providers-text",children:e.jsx(be,{children:i("users:noProvidersLinked")})})},t)]}),e.jsxs(Ge,{className:"kc-available-idps",title:i("availableIdPs"),children:[e.jsx(xe,{children:e.jsx(be,{className:"kc-available-idps-text",children:i("availableIdPsText")})}),e.jsx(je,{loader:K,isPaginated:!1,ariaLabelKey:"users:LinkedIdPs",className:"kc-linked-IdPs-table",columns:[{name:"alias",displayKey:"common:name",cellFormatters:[V(),Ls()],transforms:[B(20)]},{name:"type",displayKey:"common:type",cellFormatters:[V()],cellRenderer:D,transforms:[B(60)]},{name:"",cellFormatters:[V()],cellRenderer:O}],emptyState:e.jsx(xe,{className:"kc-no-providers-text",children:e.jsx(be,{children:i("users:noAvailableIdentityProviders")})})},t)]})]})]})},At=({id:s,name:t})=>{const{t:n}=R("users"),{adminClient:o}=G(),{addAlert:a,addError:m}=_(),l=async c=>{try{const u=c.filter(p=>p.client===void 0).map(p=>p.role).flat();await o.users.addRealmRoleMappings({id:s,roles:u}),await Promise.all(c.filter(p=>p.client!==void 0).map(p=>o.users.addClientRoleMappings({id:s,clientUniqueId:p.client.id,roles:[p.role]}))),a(n("roleMappingUpdatedSuccess"),M.success)}catch(u){m("clients:roleMappingUpdatedError",u)}};return e.jsx(lt,{name:t,id:s,type:"users",save:l})},Et=()=>{const{adminClient:s}=G(),{id:t}=Fe(),{realm:n}=Ce(),{t:o}=R("sessions"),a=()=>s.users.listSessions({id:t,realm:n});return e.jsx(ne,{variant:"light",className:"pf-u-p-0",children:e.jsx(Xs,{loader:a,hiddenColumns:["username","type"],emptyInstructions:o("noSessionsForUser"),logoutUser:t})})};function Or(){const{adminClient:s}=G(),{realm:t}=Ce(),{id:n}=Fe(),{t:o}=R("users"),[a,m]=y.useState(),[l,c]=y.useState(),[u,p]=y.useState(0),x=()=>p(i=>i+1);return De(async()=>{const[i,d,b]=await Promise.all([s.users.findOne({id:n}),s.realms.findOne({realm:t}),s.attackDetection.findOne({id:n})]);if(!i||!d||!b)throw new Error(o("common:notFound"));const g=d.bruteForceProtected,F=g&&b.disabled;return{user:i,bruteForced:{isBruteForceProtected:g,isLocked:F}}},({user:i,bruteForced:d})=>{m(i),c(d)},[u]),!a||!l?e.jsx(_e,{}):e.jsx(Nt,{user:a,bruteForced:l,refresh:x})}const Nt=({user:s,bruteForced:t,refresh:n})=>{const{t:o}=R("users"),{realm:a}=Ce(),{adminClient:m}=G(),{addAlert:l,addError:c}=_(),u=Rs(),{hasAccess:p}=We(),x=de({mode:"onChange",defaultValues:s}),i=h=>Es({realm:a,id:s.id,tab:h}),d=h=>Us(i(h)),b=d("settings"),g=d("attributes"),F=d("credentials"),I=d("role-mapping"),K=d("groups"),$=d("consents"),X=d("identity-provider-links"),S=d("sessions"),H=async h=>{try{await m.users.update({id:s.id},{...h,username:h.username?.trim(),attributes:{...s.attributes,...h.attributes}}),l(o("userSaved"),M.success),n()}catch(E){st(E)?c(tt(E),E):c("users:userCreateError",E)}},[D,L]=ie({titleKey:"users:deleteConfirm",messageKey:"users:deleteConfirmCurrentUser",continueButtonLabel:"common:delete",continueButtonVariant:te.danger,onConfirm:async()=>{try{await m.users.del({id:s.id}),l(o("userDeletedSuccess"),M.success),u(As({realm:a}))}catch(h){c("users:userDeletedError",h)}}}),[O,P]=ie({titleKey:"users:impersonateConfirm",messageKey:"users:impersonateConfirmDialog",continueButtonLabel:"users:impersonate",onConfirm:async()=>{try{const h=await m.users.impersonation({id:s.id},{user:s.id,realm:a});h.sameRealm?window.location=h.redirect:window.open(h.redirect,"_blank")}catch(h){c("users:impersonateError",h)}}});return e.jsxs(e.Fragment,{children:[e.jsx(P,{}),e.jsx(L,{}),e.jsx(Ks,{titleKey:s.username,className:"kc-username-view-header",divider:!1,dropdownItems:[e.jsx(Pe,{isDisabled:!s.access?.impersonate,onClick:()=>O(),children:o("impersonate")},"impersonate"),e.jsx(Pe,{isDisabled:!s.access?.manage,onClick:()=>D(),children:o("common:delete")},"delete")],onToggle:h=>H({...s,enabled:h}),isEnabled:s.enabled}),e.jsx(ne,{variant:"light",className:"pf-u-p-0",children:e.jsx(Ms,{children:e.jsx(ze,{...x,children:e.jsxs(Ns,{isBox:!0,mountOnEnter:!0,defaultLocation:i("settings"),children:[e.jsx(Z,{"data-testid":"user-details-tab",title:e.jsx(ee,{children:o("common:details")}),...b,children:e.jsx(ne,{variant:"light",children:e.jsx(et,{save:H,user:s,bruteForce:t})})}),e.jsx(Z,{"data-testid":"attributes",title:e.jsx(ee,{children:o("common:attributes")}),...g,children:e.jsx(yt,{user:s})}),e.jsx(Z,{"data-testid":"credentials",isHidden:!s.access?.view,title:e.jsx(ee,{children:o("common:credentials")}),...F,children:e.jsx(Lt,{user:s})}),e.jsx(Z,{"data-testid":"role-mapping-tab",isHidden:!s.access?.mapRoles,title:e.jsx(ee,{children:o("roleMapping")}),...I,children:e.jsx(At,{id:s.id,name:s.username})}),p("query-groups")&&e.jsx(Z,{"data-testid":"user-groups-tab",title:e.jsx(ee,{children:o("common:groups")}),...K,children:e.jsx(Dt,{user:s})}),e.jsx(Z,{"data-testid":"user-consents-tab",title:e.jsx(ee,{children:o("consents")}),...$,children:e.jsx(jt,{})}),p("view-identity-providers")&&e.jsx(Z,{"data-testid":"identity-provider-links-tab",title:e.jsx(ee,{children:o("identityProviderLinks")}),...X,children:e.jsx(Rt,{userId:s.id})}),e.jsx(Z,{"data-testid":"user-sessions-tab",title:e.jsx(ee,{children:o("sessions")}),...S,children:e.jsx(Et,{})})]})})})})]})};export{Or as default};
//# sourceMappingURL=EditUser-0c45def3.js.map
